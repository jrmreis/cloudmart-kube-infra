# roles/ai-assistant/tasks/summary.yml
---
- name: Gather deployment statistics
  set_fact:
    deployment_stats:
      project: "{{ project_name }}"
      environment: "{{ environment }}"
      region: "{{ aws_region }}"
      tables_created: "{{ dynamodb_table_results.results | map(attribute='table.table_name') | list }}"
      functions_deployed: "{{ lambda_function_results.results | selectattr('invocation', 'defined') | map(attribute='invocation.function_name') | list }}"
      iam_role: "{{ lambda_role_result.arn | default('N/A') }}"
      bedrock_enabled: "{{ bedrock_enabled }}"
      event_mapping: "{{ ai_assistant_event_mapping_uuid | default('N/A') }}"

- name: Display comprehensive deployment summary
  debug:
    msg:
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘                CloudMart AI Assistant Deployment            â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ Status: âœ… DEPLOYMENT COMPLETED SUCCESSFULLY                â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ Configuration:                                               â•‘"
      - "â•‘   Project: {{ deployment_stats.project | ljust(52) }}â•‘"
      - "â•‘   Environment: {{ deployment_stats.environment | ljust(48) }}â•‘"
      - "â•‘   Region: {{ deployment_stats.region | ljust(49) }}â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ Infrastructure Deployed:                                     â•‘"
      - "â•‘   ğŸ“Š DynamoDB Tables: {{ deployment_stats.tables_created | length | string | ljust(40) }}â•‘"
      - "â•‘   âš¡ Lambda Functions: {{ deployment_stats.functions_deployed | length | string | ljust(39) }}â•‘"
      - "â•‘   ğŸ” IAM Resources: Configured                               â•‘"
      - "â•‘   ğŸ“ˆ CloudWatch: Monitoring enabled                         â•‘"
      - "â•‘   ğŸ¤– Bedrock Integration: {{ ('Enabled' if deployment_stats.bedrock_enabled else 'Disabled') | ljust(33) }}â•‘"
      - "â•‘   ğŸ”„ Stream Processing: {{ ('Configured' if deployment_stats.event_mapping != 'N/A' else 'Not configured') | ljust(35) }}â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ Resources Created:                                           â•‘"

- name: Display DynamoDB tables
  debug:
    msg: "â•‘   ğŸ“Š {{ item | ljust(56) }}â•‘"
  loop: "{{ deployment_stats.tables_created }}"

- name: Display Lambda functions
  debug:
    msg: "â•‘   âš¡ {{ item | ljust(56) }}â•‘"
  loop: "{{ deployment_stats.functions_deployed }}"

- name: Display final summary
  debug:
    msg:
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ Next Steps:                                                  â•‘"
      - "â•‘   1. Test Lambda functions via AWS Console                   â•‘"
      - "â•‘   2. Verify DynamoDB stream processing                       â•‘"
      - "â•‘   3. Configure Bedrock model access                          â•‘"
      - "â•‘   4. Set up application integration                          â•‘"
      - "â•‘   5. Monitor CloudWatch logs and metrics                     â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ Documentation:                                               â•‘"
      - "â•‘   ğŸ“– Lambda logs: /aws/lambda/<function-name>                â•‘"
      - "â•‘   ğŸ“ˆ Metrics: CloudWatch â†’ Lambda/DynamoDB dashboards       â•‘"
      - "â•‘   ğŸ” Troubleshooting: Check CloudWatch logs for errors      â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

- name: Save deployment information to file
  copy:
    content: |
      CloudMart AI Assistant Deployment Summary
      =========================================
      Timestamp: {{ ansible_date_time.iso8601 }}
      Project: {{ deployment_stats.project }}
      Environment: {{ deployment_stats.environment }}
      Region: {{ deployment_stats.region }}
      
      DynamoDB Tables:
      {% for table in deployment_stats.tables_created %}
      - {{ table }}
      {% endfor %}
      
      Lambda Functions:
      {% for function in deployment_stats.functions_deployed %}
      - {{ function }}
      {% endfor %}
      
      IAM Role: {{ deployment_stats.iam_role }}
      Bedrock Enabled: {{ deployment_stats.bedrock_enabled }}
      Event Source Mapping: {{ deployment_stats.event_mapping }}
      
      Deployment completed successfully!
    dest: "./ai-assistant-deployment-{{ deployment_stats.environment }}-{{ ansible_date_time.epoch }}.log"
  delegate_to: localhost
